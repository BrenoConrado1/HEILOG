<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>HEILOG - Painel do Analista</title>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Chart.js e Adapters -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-matrix"></script>

  <style>
    body { background-color: #111827; }
    .modal-backdrop { transition: opacity 0.3s ease; }
    .kpi-card-sm { background-color: rgba(31,41,55,.7); border: 1px solid rgba(75,85,99,.5); }
    @keyframes pulse-red { 50% { background-color: rgba(239,68,68,.15); } }
    .animate-pulse-red { animation: pulse-red 2s cubic-bezier(.4,0,.6,1) infinite; }
    @keyframes pulse-yellow { 50% { background-color: rgba(245,158,11,.15); } }
    .animate-pulse-yellow { animation: pulse-yellow 2s cubic-bezier(.4,0,.6,1) infinite; }
    #performance-chart { cursor: pointer; }
    .alert-banner { animation: fadeIn-slideDown .5s ease-out forwards; }
    @keyframes fadeIn-slideDown { from { opacity:0; transform: translateY(-20px);} to {opacity:1; transform: translateY(0);} }
  </style>
</head>

<body class="text-white font-sans">
<div class="max-w-screen-2xl mx-auto p-4 sm:p-6 lg:p-8">

  <!-- Cabeçalho -->
  <header class="mb-6 flex flex-wrap justify-between items-center gap-4">
    <div>
      <h1 class="text-3xl font-bold">Painel do Analista</h1>
      <p class="text-gray-400 mt-1">Visão em tempo real do pátio - HEILOG</p>
      <p id="firebase-status" class="text-xs mt-2 text-gray-500"></p>
    </div>

    <div id="predictive-alert" class="w-full md:w-auto text-center md:text-right"></div>

    <!-- Botão de controle de som -->
    <div>
      <button id="toggle-sound-btn" class="p-2 rounded-full hover:bg-gray-700" title="Ativar/Desativar Som"></button>
    </div>
  </header>

  <!-- Alertas do Sistema -->
  <div id="system-alerts-container" class="mb-6 space-y-2"></div>

  <!-- Abas -->
  <div class="mb-4">
    <div class="border-b border-gray-700">
      <nav class="-mb-px flex space-x-8" aria-label="Tabs">
        <button id="tab-patio" class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-lg border-blue-500 text-white">Pátio</button>
        <button id="tab-historico" class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-lg border-transparent text-gray-400 hover:text-gray-200 hover:border-gray-300">Histórico</button>
        <button id="tab-ocorrencias" class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-lg border-transparent text-gray-400 hover:text-gray-200 hover:border-gray-300">Ocorrências</button>
        <button id="tab-performance" class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-lg border-transparent text-gray-400 hover:text-gray-200 hover:border-gray-300">Perf. do Turno</button>
        <button id="tab-dashboard" class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-lg border-transparent text-gray-400 hover:text-gray-200 hover:border-gray-300">Dashboard</button>
      </nav>
    </div>
  </div>

  <!-- Conteúdo -->
  <div id="main-content">
    <!-- KPIs + Gráfico lateral -->
    <section id="kpi-section" class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
      <div class="lg:col-span-2 grid grid-cols-1 sm:grid-cols-3 gap-6" id="kpi-container"></div>

      <div class="bg-gray-800 p-4 rounded-lg shadow-lg flex flex-col justify-center items-center">
        <h3 id="context-chart-title" class="text-lg font-semibold text-white mb-2">Composição do Pátio</h3>
        <div id="context-chart-container" class="relative w-full h-full min-h-52">
          <canvas id="context-chart" class="max-h-52"></canvas>
          <div id="context-chart-no-data" class="absolute inset-0 flex items-center justify-center text-gray-400 hidden">
            <span>Pátio vazio.</span>
          </div>
        </div>
      </div>
    </section>

    <!-- Tabela principal (Pátio / Histórico / Ocorrências) -->
    <main id="table-main-content" class="bg-gray-800 p-6 rounded-lg shadow-lg">
      <div class="flex flex-wrap gap-4 justify-between items-center mb-4">
        <h2 id="table-title" class="text-2xl font-semibold">Pátio</h2>

        <div id="filters-container" class="flex flex-wrap items-center gap-4">
          <!-- Filtros avançados (Histórico) -->
          <div id="advanced-filters" class="hidden flex-wrap items-center gap-4">
            <input type="date" id="filter-date" class="bg-gray-700 border border-gray-600 rounded-lg py-2 px-3 text-white focus:outline-none focus:ring-2 focus:ring-blue-500" />
            <select id="filter-shift" class="bg-gray-700 border border-gray-600 rounded-lg py-2 px-3 text-white focus:outline-none focus:ring-2 focus:ring-blue-500">
              <option value="todos">Todos os Turnos</option>
              <option value="1">1º Turno (06-14h)</option>
              <option value="2">2º Turno (14-22h)</option>
              <option value="3">3º Turno (22-06h)</option>
            </select>
            <button id="clear-date-filter-btn" class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg flex items-center gap-2">Limpar</button>
          </div>

          <select id="filter-status" class="bg-gray-700 border border-gray-600 rounded-lg py-2 px-3 text-white focus:outline-none focus:ring-2 focus:ring-blue-500"></select>

          <select id="filter-transportadora" class="bg-gray-700 border border-gray-600 rounded-lg py-2 px-3 text-white focus:outline-none focus:ring-2 focus:ring-blue-500">
            <option value="todas">Todas Transportadoras</option>
          </select>

          <input type="text" id="search-input" placeholder="Buscar por DT ou Motorista..." class="w-full sm:w-auto bg-gray-700 border border-gray-600 rounded-lg py-2 pl-4 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500"/>

          <button id="clear-history-btn" class="hidden bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg flex items-center gap-2">Limpar Histórico</button>
          <button id="clear-occurrences-btn" class="hidden bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg flex items-center gap-2">Limpar Ocorrências</button>

          <button id="export-csv-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg flex items-center gap-2">Exportar</button>
        </div>
      </div>

      <div class="overflow-x-auto">
        <table class="w-full text-left">
          <thead id="table-head"></thead>
          <tbody id="table-body"></tbody>
        </table>
      </div>
    </main>

    <!-- Performance do turno -->
    <div id="performance-content" class="hidden">
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <div class="lg:col-span-1 space-y-6">
          <div class="bg-gray-800 p-4 rounded-lg shadow-lg">
            <h3 id="hora-hora-title" class="text-xl font-bold mb-4">Finalizados (Hora a Hora)</h3>
            <div id="hora-hora-table" class="max-h-80 overflow-y-auto"></div>
          </div>

          <div class="bg-gray-800 p-4 rounded-lg shadow-lg">
            <h3 class="text-lg font-bold mb-4">Fluxo Carregamento (Finalizados no Turno)</h3>
            <div id="fluxo-carregamento-kpis" class="grid grid-cols-2 gap-4"></div>
          </div>

          <div class="bg-gray-800 p-4 rounded-lg shadow-lg">
            <h3 class="text-lg font-bold mb-4">Fluxo para Entrar (Veículos no Pátio)</h3>
            <div id="fluxo-entrar-kpis" class="grid grid-cols-2 gap-4"></div>
          </div>
        </div>

        <div class="lg:col-span-2 bg-gray-800 p-4 rounded-lg shadow-lg">
          <h3 id="performance-chart-title" class="text-xl font-bold mb-4">Finalizados (Hora a Hora)</h3>
          <div id="performance-chart-container" class="relative h-96">
            <canvas id="performance-chart"></canvas>
            <div id="performance-chart-no-data" class="absolute inset-0 flex items-center justify-center text-gray-400 hidden">
              <span>Sem finalizações no turno para exibir.</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Dashboard gerencial -->
    <div id="dashboard-content" class="hidden">
      <div class="flex justify-end mb-4">
        <select id="dashboard-transportadora-filter" class="bg-gray-700 border border-gray-600 rounded-lg py-2 px-3 text-white focus:outline-none focus:ring-2 focus:ring-blue-500">
          <option value="todas">Todas Transportadoras</option>
        </select>
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
        <div class="bg-gray-800 p-6 rounded-lg shadow-lg">
          <h3 class="text-xl font-bold mb-4">Produtividade Diária (Últimos 7 dias)</h3>
          <div class="relative h-80">
            <canvas id="daily-productivity-chart"></canvas>
          </div>
        </div>

        <div class="bg-gray-800 p-6 rounded-lg shadow-lg">
          <h3 class="text-xl font-bold mb-4">Evolução do TMP (Últimos 7 dias)</h3>
          <div class="relative h-80">
            <canvas id="tmp-evolution-chart"></canvas>
          </div>
        </div>

        <div class="bg-gray-800 p-6 rounded-lg shadow-lg">
          <h3 class="text-xl font-bold mb-4">Ranking de Volume (Últimos 7 dias)</h3>
          <div class="relative h-80">
            <canvas id="volume-ranking-chart"></canvas>
          </div>
        </div>

        <div class="bg-gray-800 p-6 rounded-lg shadow-lg">
          <h3 class="text-xl font-bold mb-4">Produtividade por Turno (Últimos 7 dias)</h3>
          <div class="relative h-80">
            <canvas id="shift-comparison-chart"></canvas>
          </div>
        </div>

        <div class="lg:col-span-2 bg-gray-800 p-6 rounded-lg shadow-lg">
          <h3 class="text-xl font-bold mb-4">Heatmap de Produtividade (Semana)</h3>
          <div class="relative h-96">
            <canvas id="heatmap-chart"></canvas>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modais -->
<div id="details-modal" class="fixed inset-0 bg-black bg-opacity-70 z-50 flex justify-center items-center modal-backdrop hidden"></div>
<div id="occurrence-modal" class="fixed inset-0 bg-black bg-opacity-70 z-50 flex justify-center items-center modal-backdrop hidden"></div>
<div id="resolution-modal" class="fixed inset-0 bg-black bg-opacity-70 z-50 flex justify-center items-center modal-backdrop hidden"></div>
<div id="confirm-modal" class="fixed inset-0 bg-black bg-opacity-70 z-50 flex justify-center items-center modal-backdrop hidden">
  <div class="bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-sm">
    <h3 id="confirm-modal-title" class="text-xl font-bold text-white mb-4">Confirmar Ação</h3>
    <p id="confirm-modal-text" class="text-gray-300 mb-6"></p>
    <div class="flex justify-end gap-4">
      <button id="confirm-modal-cancel" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg">Cancelar</button>
      <button id="confirm-modal-confirm" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg">Confirmar</button>
    </div>
  </div>
</div>

<!-- Firebase + App -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
  import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
  import { getFirestore, collection, onSnapshot, doc, setDoc, deleteDoc, addDoc, serverTimestamp, setLogLevel, updateDoc, writeBatch, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

  // --- Configuração ---
  const firebaseConfig = typeof __firebase_config !== 'undefined'
    ? JSON.parse(__firebase_config)
    : {
      apiKey: "AIzaSyB9B2-xYb6gr92cQDbajriQiinfQurrOwI",
      authDomain: "heilog-logistica.firebaseapp.com",
      projectId: "heilog-logistica",
      storageBucket: "heilog-logistica.appspot.com",
      messagingSenderId: "790492229739",
      appId: "1:790492229739:web:de49887de535a839e8412e"
    };

  // === IMPORTANTE (GitHub / Seu Firestore) ===
  // Sua estrutura no console está assim: public / data / <coleções>
  // Ex.: public (coleção) -> data (documento) -> drivers (coleção) -> CPF (documento)
  // Então o "BASE" é sempre: ['public','data']
  const DB_BASE = ['public', 'data'];

  // --- Estado global ---
  let db;
  let patioData = [];
  let historicoData = [];
  let ocorrenciasData = [];
  let activeTab = 'patio';
  let selectedOperacao = null;

  let contextChart = null;
  let performanceChart = null;
  let dailyProductivityChart = null, tmpEvolutionChart = null, shiftComparisonChart = null, volumeRankingChart = null, heatmapChart = null;

  let notifiedVehicles = new Set();
  let newlyAdded = new Set();

  let audioContext;
  let timerIntervalId = null;
  let confirmCallback = null;
  let soundEnabled = true;

  // mapa CPF -> telefone vindo do cadastro de motoristas
  let driverPhoneByCpf = {};

  const ICONS = {
    SOUND_ON: `<svg class="w-6 h-6 text-gray-300" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M19.114 5.636a9 9 0 0 1 0 12.728M16.463 8.288a5.25 5.25 0 0 1 0 7.424M6.75 8.25l4.72-4.72a.75.75 0 0 1 1.28.53v15.88a.75.75 0 0 1-1.28.53l-4.72-4.72H4.51c-.88 0-1.704-.507-1.938-1.354A9.01 9.01 0 0 1 2.25 12c0-.83.112-1.633.322-2.396C2.806 8.756 3.63 8.25 4.51 8.25H6.75Z" /></svg>`,
    SOUND_OFF: `<svg class="w-6 h-6 text-gray-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M17.25 9.75 19.5 12m0 0 2.25 2.25M19.5 12l-2.25 2.25M19.5 12l2.25-2.25M12.75 15l3-3m0 0-3-3m3 3H6.75M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" /></svg>`
  };

  // --- Utilitários ---
  const debounce = (fn, delay = 150) => {
    let t;
    return (...args) => {
      clearTimeout(t);
      t = setTimeout(() => fn(...args), delay);
    };
  };

  const formatMilliseconds = (ms) => {
    if (isNaN(ms) || ms < 0) return '00:00:00';
    const totalSeconds = Math.floor(ms / 1000);
    const hours = Math.floor(totalSeconds / 3600);
    const minutes = Math.floor((totalSeconds % 3600) / 60);
    const seconds = totalSeconds % 60;
    return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
  };

  const getElapsedTime = (registrationTime) => {
    if (!registrationTime) return '00:00:00';
    const diff = Date.now() - registrationTime;
    return formatMilliseconds(diff);
  };

  const playAlertSound = () => {
    if (!soundEnabled || !audioContext) return;
    const oscillator = audioContext.createOscillator();
    const gainNode = audioContext.createGain();
    oscillator.connect(gainNode);
    gainNode.connect(audioContext.destination);
    oscillator.type = 'sine';
    oscillator.frequency.setValueAtTime(880, audioContext.currentTime);
    gainNode.gain.setValueAtTime(0.5, audioContext.currentTime);
    gainNode.gain.exponentialRampToValueAtTime(0.0001, audioContext.currentTime + 0.5);
    oscillator.start();
    oscillator.stop(audioContext.currentTime + 0.5);
  };

  const showBrowserNotification = (title, body, tag) => {
    if (!("Notification" in window)) return;
    if (Notification.permission === "granted") {
      new Notification(title, { body, tag, icon: './favicon.ico' });
    } else if (Notification.permission !== "denied") {
      Notification.requestPermission().then(permission => {
        if (permission === "granted") new Notification(title, { body, tag, icon: './favicon.ico' });
      });
    }
  };

  // === Helpers Firestore: base path ===
  const colRef = (...segments) => collection(db, ...DB_BASE, ...segments);
  const docRef = (...segments) => doc(db, ...DB_BASE, ...segments);

  // --- Regra de prioridade ---
  const getPriorityStatusLogic = (op) => {
    let statusText = "Normal", className = "bg-gray-500/20 text-gray-300", isAlert = false;

    if (op.status === 'Finalizado') return { statusText: op.status, className: "bg-green-500/20 text-green-300", isAlert: false };
    if (op.status === 'Cancelado') return { statusText: op.status, className: "bg-red-500/20 text-red-300", isAlert: false };

    const { agenda, xtAdicional, data } = op || {};
    if (!agenda) return { statusText, className, isAlert };

    const getScheduledDateTime = (dateStr, timeStr) => {
      if (!dateStr || !dateStr.match(/^\d{2}\/\d{2}\/\d{4}$/)) dateStr = new Date().toLocaleDateString('pt-BR');
      if (!timeStr || !timeStr.match(/^\d{1,2}:\d{2}(:\d{2})?$/)) return null;
      const timeParts = timeStr.split(':');
      const [day, month, year] = dateStr.split('/');
      const [hours, minutes] = timeParts;
      const seconds = timeParts.length > 2 ? timeParts[2] : 0;
      return new Date(year, parseInt(month, 10) - 1, day, hours, minutes, seconds);
    };

    const now = new Date();
    const scheduledDateTime = getScheduledDateTime(data, agenda);

    let isGradeQueimada = false;
    let isAtrasado = false;
    let isAtencao = false;

    const isTop18 = (xtAdicional || '').toUpperCase().includes('TOP');

    if (scheduledDateTime) {
      const diffHours = (now.getTime() - scheduledDateTime.getTime()) / 3600000;
      const today = new Date(now); today.setHours(0,0,0,0);
      const scheduledDay = new Date(scheduledDateTime); scheduledDay.setHours(0,0,0,0);

      if (today > scheduledDay) {
        isGradeQueimada = true;
      } else if (today.getTime() === scheduledDay.getTime()) {
        if (diffHours > 1) isAtrasado = true;
        else if (diffHours > 0) isAtencao = true;
      }
    }

    if (isGradeQueimada) {
      statusText = "Grade queimada";
      className = "bg-yellow-500/30 text-yellow-300 border-yellow-500/50";
      isAlert = true;
    } else if (isAtrasado) {
      statusText = "Atrasado";
      className = "bg-red-600/30 text-red-400 border-red-500/50";
    } else if (isAtencao) {
      statusText = "Atenção";
      className = "bg-amber-500/30 text-amber-400 border-amber-500/50";
    } else if (isTop18) {
      statusText = "Prioridade (TOP 18)";
      className = "bg-red-500/30 text-red-300 border-red-500/50";
      isAlert = true;
    }

    return { statusText, className, isAlert };
  };

  // --- TELEFONE / WHATSAPP ---
  const getTelefoneFromOperacao = (op = {}) => {
    const candidates = [];
    ['telefone','telefoneMotorista','celular','celularMotorista','phone','fone','foneMotorista'].forEach(field => {
      if (op[field]) candidates.push(op[field]);
    });

    const cpfRaw = op.cpf || op.cpfMotorista || op.driverCpf || op.document;
    if (cpfRaw) {
      const cpfKey = String(cpfRaw).replace(/\D/g, '');
      if (driverPhoneByCpf[cpfKey]) candidates.push(driverPhoneByCpf[cpfKey]);
    }

    const first = candidates.find(v => v !== undefined && v !== null && v !== '');
    if (!first) return null;

    const digits = String(first).replace(/\D/g, '');
    if (digits.length < 10) return null; // DDD + número
    return digits;
  };

  // --- Turno / Hora-a-hora ---
  const getShiftWindow = (now = new Date()) => {
    const h = now.getHours();
    const base = new Date(now);
    base.setMinutes(0,0,0);

    // 1º 06-14 | 2º 14-22 | 3º 22-06
    if (h >= 6 && h < 14) {
      const start = new Date(now); start.setHours(6,0,0,0);
      const end = new Date(now); end.setHours(14,0,0,0);
      return { shift: 1, start, end, label: "1º Turno (06-14h)" };
    }
    if (h >= 14 && h < 22) {
      const start = new Date(now); start.setHours(14,0,0,0);
      const end = new Date(now); end.setHours(22,0,0,0);
      return { shift: 2, start, end, label: "2º Turno (14-22h)" };
    }
    // 3º turno cruza meia-noite
    if (h >= 22) {
      const start = new Date(now); start.setHours(22,0,0,0);
      const end = new Date(now); end.setDate(end.getDate()+1); end.setHours(6,0,0,0);
      return { shift: 3, start, end, label: "3º Turno (22-06h)" };
    } else {
      // h < 6: ainda é 3º turno que começou ontem às 22
      const start = new Date(now); start.setDate(start.getDate()-1); start.setHours(22,0,0,0);
      const end = new Date(now); end.setHours(6,0,0,0);
      return { shift: 3, start, end, label: "3º Turno (22-06h)" };
    }
  };

  const bucketHours = (start, end) => {
    const buckets = [];
    const cur = new Date(start); cur.setMinutes(0,0,0);
    while (cur < end) {
      buckets.push(new Date(cur));
      cur.setHours(cur.getHours()+1);
    }
    return buckets;
  };

  const isWithin = (t, start, end) => (t >= start.getTime() && t < end.getTime());

  // Classificação simples (Vendas vs Baldeio AE) baseada em campos comuns
  const classifyVendasVsAE = (op = {}) => {
    const txt = `${op.destino||''} ${op.tipo||''} ${op.operacao||''} ${op.xtAdicional||''}`.toUpperCase();
    if (txt.includes('BALDEIO') || txt.includes('ARMAZ') || txt.includes('AE')) return 'AE';
    return 'VENDAS';
  };

  // --- RENDER PRINCIPAL ---
  const render = () => {
    if (activeTab === 'performance') { renderPerformanceDashboard(); return; }
    if (activeTab === 'dashboard') { renderManagerDashboard(); return; }

    const searchTerm = document.getElementById('search-input').value.toLowerCase();
    const statusFilter = document.getElementById('filter-status').value;
    const transportadoraFilter = document.getElementById('filter-transportadora').value;
    const dateFilterValue = document.getElementById('filter-date').value;
    const shiftFilterValue = document.getElementById('filter-shift').value;

    let dataSet = [];

    if (activeTab === 'patio') {
      dataSet = patioData || [];
    } else if (activeTab === 'ocorrencias') {
      dataSet = ocorrenciasData || [];
    } else if (activeTab === 'historico') {
      let filteredHistorico = historicoData || [];

      if (dateFilterValue) {
        const filterDate = new Date(dateFilterValue);
        filterDate.setDate(filterDate.getDate() + 1);
        const filterDateString = filterDate.toDateString();

        filteredHistorico = filteredHistorico.filter(op => {
          if (!op.finishedTime) return false;
          const finishedDate = new Date(op.finishedTime).toDateString();
          return finishedDate === filterDateString;
        });
      }

      if (shiftFilterValue !== 'todos' && dateFilterValue) {
        const shift = parseInt(shiftFilterValue, 10);
        const shiftTimes = { 1:{start:6,end:14}, 2:{start:14,end:22}, 3:{start:22,end:6} };
        const { start, end } = shiftTimes[shift];

        filteredHistorico = filteredHistorico.filter(op => {
          if (!op.finishedTime) return false;
          const opHour = new Date(op.finishedTime).getHours();
          if (start < end) return opHour >= start && opHour < end;
          return opHour >= start || opHour < end;
        });
      }
      dataSet = filteredHistorico;
    }

    const filteredData = dataSet.filter(op => {
      if (activeTab === 'ocorrencias') {
        return (op.dt?.toLowerCase() || '').includes(searchTerm) ||
          (op.description?.toLowerCase() || '').includes(searchTerm);
      }

      const searchMatch = (op.dt?.toLowerCase() || '').includes(searchTerm) ||
        (op.motorista?.toLowerCase() || '').includes(searchTerm);

      const transportadoraMatch = transportadoraFilter === 'todas' || op.transportadora === transportadoraFilter;

      let statusMatch = statusFilter === 'todos';
      if (!statusMatch) {
        const { statusText } = getPriorityStatusLogic(op);
        statusMatch = statusText.toLowerCase().includes(statusFilter.toLowerCase());
      }

      return searchMatch && statusMatch && transportadoraMatch;
    });

    renderTable(filteredData);
    renderKPIs();
    renderContextualChart();
    updateTransportadoraFilter();
  };

  const debouncedRender = debounce(render, 80);

  const renderTable = (data) => {
    const tableBody = document.getElementById('table-body');
    const tableHead = document.getElementById('table-head');

    const headers = {
      patio: 'DT,Status,Agenda,Tempo no Pátio,Motorista,Transportadora,Ações',
      historico: 'DT,Status Final,Agenda,Motorista,Transportadora,Finalizado Em,Ações',
      ocorrencias: 'Data,DT,Canal,Prioridade,Problema Identificado,Descrição,Status,Ações'
    };

    tableHead.innerHTML = `<tr class="border-b border-gray-700">${headers[activeTab].split(',')
      .map(h => `<th class="p-4 text-sm font-semibold text-gray-400">${h}</th>`).join('')}</tr>`;

    if (!data.length) {
      const colspan = headers[activeTab].split(',').length;
      tableBody.innerHTML = `<tr><td colspan="${colspan}" class="text-center p-8 text-gray-400">
          Nenhuma informação encontrada para os filtros selecionados.
        </td></tr>`;
      return;
    }

    tableBody.innerHTML = data.map(op => {
      const { statusText, className } = getPriorityStatusLogic(op);
      const isNew = newlyAdded.has(op.id);
      const pulseClass = isNew ? (className.includes('red') ? 'animate-pulse-red' : 'animate-pulse-yellow') : '';
      const statusBadge = `<span class="px-3 py-1 text-xs font-medium rounded-full ${className}">${statusText}</span>`;

      let opDataForActions = op;
      if (activeTab === 'ocorrencias') {
        opDataForActions = patioData.find(p => p.id === op.operacaoId) || historicoData.find(h => h.id === op.operacaoId) || {};
      }

      const telefoneDigits = getTelefoneFromOperacao(opDataForActions);
      const motorista = opDataForActions.motorista || 'Motorista';
      const dt = opDataForActions.dt || op.dt || '';

      const whatsappMsgIcon = `<svg class="w-5 h-5 pointer-events-none" fill="currentColor" viewBox="0 0 24 24">
        <path d="M.057 24l1.687-6.163c-1.041-1.804-1.588-3.849-1.587-5.946.003-6.556
        5.338-11.891 11.893-11.891 3.181.001 6.167 1.24 8.413 3.488 2.245 2.248
        3.487 5.235 3.487 8.413 0 6.557-5.338 11.892-11.894 11.892-1.99 0-3.903-.52-5.586-1.456l-6.305
        1.654zm6.597-3.807c1.676.995 3.276 1.591 5.392 1.592 5.448 0
        9.886-4.434 9.889-9.885.002-5.447-4.435-9.884-9.888-9.884-5.448
        0-9.886 4.434-9.889 9.884-.001 2.225.651 3.891 1.746
        5.634l-.999 3.648 3.742-.981zm11.387-5.464c-.074-.124-.272-.198-.57-.347-.297-.149-1.758-.868-2.031-.967-.272-.099-.47-.149-.669.149-.198.297-.768.967-.941
        1.165-.173.198-.347.223-.644.074-.297-.149-1.255-.462-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.297-.347.446-.521.151-.172.2-.296.3-.495.099-.198.05-.371-.025-.521-.075-.148-.669-1.611-.916-2.206-.242-.579-.487-.5-.669-.51l-.57-.01c-.198
        0-.52.074-.792.372-.272.296-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875
        1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489
        1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719
        2.006-1.413.248-.695.248-1.289.173-1.413z"/>
      </svg>`;

      let whatsappButtonHTML;
      if (telefoneDigits) {
        const message = `Olá ${motorista}, por favor, dirija-se à doca para o carregamento da DT ${dt}.`;
        const encodedMessage = encodeURIComponent(message);
        const whatsappUrl = `https://wa.me/55${telefoneDigits}?text=${encodedMessage}`;
        whatsappButtonHTML = `<a href="${whatsappUrl}" target="_blank" rel="noopener noreferrer" title="WhatsApp" class="text-green-400 hover:text-green-300">
          ${whatsappMsgIcon.replace('pointer-events-none','')}
        </a>`;
      } else {
        whatsappButtonHTML = `<button title="WhatsApp (Telefone indisponível)" class="text-gray-600 cursor-not-allowed" disabled>
          ${whatsappMsgIcon}
        </button>`;
      }

      let specificActions = '';
      if (activeTab === 'patio') {
        specificActions = `
          <button data-action="details" data-id="${op.id}" title="Ver Detalhes">
            <svg class="w-5 h-5 text-sky-400 hover:text-sky-300 pointer-events-none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"
              stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/>
              <circle cx="12" cy="12" r="3"/>
            </svg>
          </button>
          <button data-action="occurrence" data-id="${op.id}" title="Adicionar Ocorrência">
            <svg class="w-5 h-5 text-amber-400 hover:text-amber-300 pointer-events-none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"
              stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M19.3 14.8C20.1 14 21 12.6 21 11c0-4.4-3.6-8-8-8s-8 3.6-8 8c0 1.6.9 3 1.7 3.8"/>
              <path d="M12 21c-1.7 0-3-1.3-3-3h6c0 1.7-1.3 3-3 3Z"/>
              <path d="M12 6v6"/><path d="M9 9h6"/>
            </svg>
          </button>
          <button data-action="finish" data-id="${op.id}" title="Finalizar Operação">
            <svg class="w-5 h-5 text-green-400 hover:text-green-300 pointer-events-none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"
              stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <polyline points="9 11 12 14 22 4"/>
              <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/>
            </svg>
          </button>
          <button data-action="cancel" data-id="${op.id}" title="Cancelar DT" class="text-red-500 hover:text-red-400">
            <svg class="w-5 h-5 pointer-events-none" xmlns="http://www.w3.org/2000/svg" width="24" height="24"
              viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <polyline points="3 6 5 6 21 6"></polyline>
              <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
            </svg>
          </button>
        `;
      } else if (activeTab === 'ocorrencias') {
        specificActions = `<button data-action="edit-occurrence" data-id="${op.id}" title="Ver/Editar Resolução" class="text-blue-400 hover:text-blue-300">
          <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 pointer-events-none" viewBox="0 0 24 24"
            fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"/>
          </svg>
        </button>`;
      }

      const actionButtonsHTML = `<td class="p-4 flex items-center gap-4">${whatsappButtonHTML}${specificActions}</td>`;

      let rowCells = '';
      if (activeTab === 'ocorrencias') {
        rowCells = `
          <td class="p-4 text-sm">${op.timestamp ? new Date(op.timestamp.seconds * 1000).toLocaleString('pt-BR') : 'N/A'}</td>
          <td class="p-4 font-mono text-sm">${op.dt}</td>
          <td class="p-4 text-sm">${op.canal || 'N/A'}</td>
          <td class="p-4 text-sm">${op.prioridade || 'N/A'}</td>
          <td class="p-4 text-sm">${op.type}</td>
          <td class="p-4 text-sm">${op.description}</td>
          <td class="p-4 text-sm">${op.statusOcorrencia || 'Em andamento'}</td>
          ${actionButtonsHTML}
        `;
      } else {
        rowCells = `
          <td class="p-4 font-mono text-sm">${op.dt || ''}</td>
          <td class="p-4">${statusBadge}</td>
          <td class="p-4">${op.agenda || 'N/A'}</td>
          ${activeTab === 'patio'
            ? `<td class="p-4 font-mono text-sm timer-cell" data-registration-time="${op.registrationTime}">
              ${getElapsedTime(op.registrationTime)}
            </td>`
            : ''
          }
          <td class="p-4">${op.motorista || ''}</td>
          <td class="p-4">${op.transportadora || ''}</td>
          ${activeTab === 'historico'
            ? `<td class="p-4 text-sm">${op.finishedTime ? new Date(op.finishedTime).toLocaleString('pt-BR') : 'N/A'}</td>`
            : ''
          }
          ${actionButtonsHTML}
        `;
      }

      return `<tr class="border-b border-gray-700 hover:bg-gray-700/50 ${pulseClass}">${rowCells}</tr>`;
    }).join('');
  };

  const renderKPIs = () => {
    const kpiContainer = document.getElementById('kpi-container');

    const finalizadasHoje = historicoData.filter(op => op.finishedTime && new Date(op.finishedTime).toDateString() === new Date().toDateString());

    const totalPermanencia = finalizadasHoje.reduce((acc, op) => {
      if (op.registrationTime && op.finishedTime) return acc + (op.finishedTime - op.registrationTime);
      return acc;
    }, 0);

    const tempoMedioPermanencia = finalizadasHoje.length > 0 ? totalPermanencia / finalizadasHoje.length : 0;

    const kpis = {
      veiculosPatio: patioData.length,
      criticos: patioData.filter(op => {
        const s = getPriorityStatusLogic(op).statusText;
        return s.includes('Grade queimada') || s.includes('Prioridade');
      }).length,
      finalizadasHoje: finalizadasHoje.length,
      tmp: formatMilliseconds(tempoMedioPermanencia),
    };

    kpiContainer.innerHTML = `
      <div class="bg-gray-800 p-6 rounded-lg shadow-lg flex items-center space-x-4">
        <div class="p-3 rounded-full bg-blue-500/20">
          <svg class="w-6 h-6 text-blue-300" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"
            fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M5 18H3c-.6 0-1-.4-1-1V7c0-.6.4-1 1-1h10c.6 0 1 .4 1 1v11"/>
            <path d="M14 9h4l4 4v4h-8v-4c0-1.1.9-2 2-2z"/>
            <circle cx="7.5" cy="18.5" r="2.5"/>
            <circle cx="17.5" cy="18.5" r="2.5"/>
          </svg>
        </div>
        <div><p class="text-sm text-gray-400">Veículos no Pátio</p><p class="text-2xl font-bold">${kpis.veiculosPatio}</p></div>
      </div>

      <div class="bg-gray-800 p-6 rounded-lg shadow-lg flex items-center space-x-4">
        <div class="p-3 rounded-full bg-red-500/20">
          <svg class="w-6 h-6 text-red-300" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"
            fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/>
            <line x1="12" y1="9" x2="12" y2="13"/>
            <line x1="12" y1="17" x2="12.01" y2="17"/>
          </svg>
        </div>
        <div><p class="text-sm text-gray-400">Críticos (Grade/Prioridade)</p><p class="text-2xl font-bold">${kpis.criticos}</p></div>
      </div>

      <div class="bg-gray-800 p-6 rounded-lg shadow-lg flex items-center space-x-4">
        <div class="p-3 rounded-full bg-green-500/20">
          <svg class="w-6 h-6 text-green-300" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"
            fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
            <polyline points="22 4 12 14.01 9 11.01"/>
          </svg>
        </div>
        <div><p class="text-sm text-gray-400">Finalizadas Hoje</p><p class="text-2xl font-bold">${kpis.finalizadasHoje}</p></div>
      </div>

      <div class="lg:col-span-2 sm:col-span-3 bg-gray-800 p-6 rounded-lg shadow-lg flex items-center space-x-4">
        <div class="p-3 rounded-full bg-purple-500/20">
          <svg class="w-6 h-6 text-purple-300" xmlns="http://www.w3.org/2000/svg" width="24" height="24"
            viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
            stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline>
          </svg>
        </div>
        <div><p class="text-sm text-gray-400">Tempo Médio de Permanência (Hoje)</p><p class="text-2xl font-bold">${kpis.tmp}</p></div>
      </div>
    `;
  };

  const renderContextualChart = () => {
    const titleEl = document.getElementById('context-chart-title');
    const noDataMsg = document.getElementById('context-chart-no-data');
    const canvas = document.getElementById('context-chart');
    const ctx = canvas.getContext('2d');

    if (contextChart) { contextChart.destroy(); contextChart = null; }

    if (activeTab === 'ocorrencias') {
      titleEl.textContent = 'Análise de Ocorrências';
      if (!ocorrenciasData.length) {
        noDataMsg.textContent = 'Nenhuma ocorrência registrada.';
        noDataMsg.classList.remove('hidden');
        canvas.style.display = 'none';
        return;
      }

      noDataMsg.classList.add('hidden'); canvas.style.display = 'block';

      const counts = ocorrenciasData.reduce((acc, op) => {
        const type = op.type || 'Outro';
        acc[type] = (acc[type] || 0) + 1;
        return acc;
      }, {});
      const chartLabels = Object.keys(counts);
      const chartValues = Object.values(counts);

      contextChart = new Chart(ctx, {
        type: 'bar',
        data: { labels: chartLabels, datasets: [{ label: 'Nº de Ocorrências', data: chartValues, borderWidth: 1 }] },
        options: {
          responsive: true, maintainAspectRatio: false,
          scales: {
            y: { beginAtZero: true, ticks: { color:'#d1d5db', stepSize: 1 }, grid: { color: 'rgba(255,255,255,0.1)' } },
            x: { ticks: { color:'#d1d5db' }, grid: { display: false } }
          },
          plugins: { legend: { display: false } }
        }
      });

    } else {
      titleEl.textContent = 'Composição do Pátio';
      if (!patioData.length) {
        noDataMsg.textContent = 'Pátio vazio.';
        noDataMsg.classList.remove('hidden');
        canvas.style.display = 'none';
        return;
      }

      noDataMsg.classList.add('hidden'); canvas.style.display = 'block';

      const counts = patioData.reduce((acc, op) => {
        const status = getPriorityStatusLogic(op).statusText.split('(')[0].trim();
        acc[status] = (acc[status] || 0) + 1;
        return acc;
      }, {});
      const chartLabels = Object.keys(counts);
      const chartValues = Object.values(counts);

      contextChart = new Chart(ctx, {
        type: 'pie',
        data: { labels: chartLabels, datasets: [{ data: chartValues, borderWidth: 2 }] },
        options: {
          responsive: true, maintainAspectRatio: false,
          plugins: { legend: { position: 'bottom', labels: { color: '#d1d5db', boxWidth: 12, padding: 15 } } }
        }
      });
    }
  };

  // --- Performance (Hora-a-hora + KPIs + Gráfico) ---
  function renderPerformanceDashboard() {
    const { start, end, label } = getShiftWindow(new Date());
    document.getElementById('hora-hora-title').textContent = `Finalizados (Hora a Hora) — ${label}`;
    document.getElementById('performance-chart-title').textContent = `Finalizados (Hora a Hora) — ${label}`;

    const buckets = bucketHours(start, end);
    const bucketMap = new Map(buckets.map(b => [b.getTime(), { vendas: 0, ae: 0, total: 0 }]));

    const finishedThisShift = historicoData
      .filter(op => typeof op.finishedTime === 'number' && isWithin(op.finishedTime, start, end));

    finishedThisShift.forEach(op => {
      const d = new Date(op.finishedTime);
      d.setMinutes(0,0,0);
      const key = d.getTime();
      if (!bucketMap.has(key)) return;
      const cls = classifyVendasVsAE(op);
      const obj = bucketMap.get(key);
      if (cls === 'AE') obj.ae += 1;
      else obj.vendas += 1;
      obj.total += 1;
    });

    // Tabela
    const rows = buckets.map(b => {
      const obj = bucketMap.get(b.getTime()) || { vendas:0, ae:0, total:0 };
      const hh = String(b.getHours()).padStart(2,'0') + ':00';
      return { hour: hh, vendas: obj.vendas, ae: obj.ae, total: obj.total };
    });

    const horaHoraTable = document.getElementById('hora-hora-table');
    horaHoraTable.innerHTML = `
      <table class="w-full text-left text-sm">
        <thead>
          <tr class="border-b border-gray-700">
            <th class="py-2 pr-2 text-gray-400">Hora</th>
            <th class="py-2 pr-2 text-gray-400">Vendas</th>
            <th class="py-2 pr-2 text-gray-400">Baldeio AE</th>
            <th class="py-2 text-gray-400">Ritmo</th>
          </tr>
        </thead>
        <tbody>
          ${rows.map(r => `
            <tr class="border-b border-gray-800">
              <td class="py-2 pr-2 font-mono">${r.hour}</td>
              <td class="py-2 pr-2">${r.vendas}</td>
              <td class="py-2 pr-2">${r.ae}</td>
              <td class="py-2 font-semibold">${r.total}</td>
            </tr>
          `).join('')}
        </tbody>
      </table>
      <div class="mt-3 text-xs text-gray-500">
        Obs.: "Vendas x Baldeio AE" é classificado por palavras-chave em destino/tipo (pode ajustar depois).
      </div>
    `;

    // KPIs do turno
    const fluxoCarregamento = document.getElementById('fluxo-carregamento-kpis');
    const fluxoEntrar = document.getElementById('fluxo-entrar-kpis');

    const totalFinalizados = finishedThisShift.length;
    const tmpMedioTurnoMs = totalFinalizados
      ? finishedThisShift.reduce((acc, op) => acc + ((op.finishedTime||0) - (op.registrationTime||op.finishedTime||0)), 0) / totalFinalizados
      : 0;

    const horasPassadas = Math.max(1, (Date.now() - start.getTime()) / 3600000);
    const ritmoMedio = totalFinalizados / horasPassadas;

    const vendasTurno = finishedThisShift.filter(op => classifyVendasVsAE(op) === 'VENDAS').length;
    const aeTurno = totalFinalizados - vendasTurno;

    fluxoCarregamento.innerHTML = `
      ${kpiSmall('Finalizados', totalFinalizados)}
      ${kpiSmall('Ritmo médio (h)', ritmoMedio.toFixed(1))}
      ${kpiSmall('TMP médio', formatMilliseconds(tmpMedioTurnoMs))}
      ${kpiSmall('Vendas / AE', `${vendasTurno} / ${aeTurno}`)}
    `;

    const patioTotal = patioData.length;
    const patioCriticos = patioData.filter(op => {
      const s = getPriorityStatusLogic(op).statusText;
      return s.includes('Grade queimada') || s.includes('Prioridade');
    }).length;
    const patioAtencao = patioData.filter(op => getPriorityStatusLogic(op).statusText === 'Atenção').length;
    const patioAtrasado = patioData.filter(op => getPriorityStatusLogic(op).statusText === 'Atrasado').length;

    fluxoEntrar.innerHTML = `
      ${kpiSmall('No pátio', patioTotal)}
      ${kpiSmall('Críticos', patioCriticos)}
      ${kpiSmall('Atenção', patioAtencao)}
      ${kpiSmall('Atrasado', patioAtrasado)}
    `;

    // Gráfico
    const perfNoData = document.getElementById('performance-chart-no-data');
    const perfCanvas = document.getElementById('performance-chart');
    const ctx = perfCanvas.getContext('2d');

    if (performanceChart) { performanceChart.destroy(); performanceChart = null; }

    if (!totalFinalizados) {
      perfNoData.classList.remove('hidden');
      perfCanvas.style.display = 'none';
      return;
    }

    perfNoData.classList.add('hidden');
    perfCanvas.style.display = 'block';

    const labels = rows.map(r => r.hour);
    const vendasSeries = rows.map(r => r.vendas);
    const aeSeries = rows.map(r => r.ae);

    performanceChart = new Chart(ctx, {
      type: 'bar',
      data: {
        labels,
        datasets: [
          { label: 'Vendas', data: vendasSeries, stack: 'stack1' },
          { label: 'Baldeio AE', data: aeSeries, stack: 'stack1' }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          x: { stacked: true, ticks: { color:'#d1d5db' }, grid: { display:false } },
          y: { stacked: true, beginAtZero: true, ticks: { color:'#d1d5db', stepSize: 1 }, grid: { color: 'rgba(255,255,255,0.1)' } }
        },
        plugins: { legend: { labels: { color: '#d1d5db' } } }
      }
    });
  }

  function kpiSmall(label, value) {
    return `
      <div class="kpi-card-sm p-3 rounded-lg">
        <div class="text-xs text-gray-400">${label}</div>
        <div class="text-lg font-bold mt-1">${value}</div>
      </div>
    `;
  }

  // --- Dashboard (últimos 7 dias) ---
  function renderManagerDashboard() {
    const select = document.getElementById('dashboard-transportadora-filter');
    const filterT = select?.value || 'todas';

    const now = new Date();
    const start = new Date(now); start.setDate(start.getDate() - 6);
    start.setHours(0,0,0,0);

    const weekData = historicoData
      .filter(op => typeof op.finishedTime === 'number' && op.finishedTime >= start.getTime())
      .filter(op => filterT === 'todas' ? true : (op.transportadora === filterT));

    // daily buckets
    const dayKeys = [];
    for (let i = 0; i < 7; i++) {
      const d = new Date(start); d.setDate(d.getDate() + i);
      dayKeys.push(d.toISOString().slice(0,10));
    }

    const dayAgg = new Map(dayKeys.map(k => [k, { count: 0, tmpSum: 0, tmpN: 0 }]));

    weekData.forEach(op => {
      const k = new Date(op.finishedTime).toISOString().slice(0,10);
      if (!dayAgg.has(k)) return;
      const a = dayAgg.get(k);
      a.count += 1;
      if (op.registrationTime && op.finishedTime) {
        a.tmpSum += (op.finishedTime - op.registrationTime);
        a.tmpN += 1;
      }
    });

    const dayLabels = dayKeys.map(k => k.slice(5)); // MM-DD
    const dayCounts = dayKeys.map(k => dayAgg.get(k).count);
    const dayTmpH = dayKeys.map(k => {
      const a = dayAgg.get(k);
      return a.tmpN ? (a.tmpSum / a.tmpN) / 3600000 : 0;
    });

    // Ranking transportadora
    const byT = new Map();
    weekData.forEach(op => {
      const t = op.transportadora || 'N/A';
      byT.set(t, (byT.get(t) || 0) + 1);
    });
    const topT = [...byT.entries()].sort((a,b) => b[1]-a[1]).slice(0, 10);
    const topTLabels = topT.map(([t]) => t.length > 28 ? t.slice(0,28)+'…' : t);
    const topTValues = topT.map(([,v]) => v);

    // Shift comparison
    const shiftAgg = { '1º': 0, '2º': 0, '3º': 0 };
    weekData.forEach(op => {
      const h = new Date(op.finishedTime).getHours();
      if (h >= 6 && h < 14) shiftAgg['1º'] += 1;
      else if (h >= 14 && h < 22) shiftAgg['2º'] += 1;
      else shiftAgg['3º'] += 1;
    });

    // Heatmap day x hour
    const heatDays = dayKeys.slice(); // iso
    const heatLabelsY = heatDays.map(k => k.slice(5)); // MM-DD
    const heatDataMap = new Map(); // key "day|hour" -> count

    weekData.forEach(op => {
      const d = new Date(op.finishedTime);
      const day = d.toISOString().slice(0,10);
      const hour = d.getHours();
      const key = `${day}|${hour}`;
      heatDataMap.set(key, (heatDataMap.get(key) || 0) + 1);
    });

    const matrixData = [];
    let vmax = 0;
    heatDays.forEach((day, y) => {
      for (let x = 0; x < 24; x++) {
        const v = heatDataMap.get(`${day}|${x}`) || 0;
        vmax = Math.max(vmax, v);
        matrixData.push({ x, y, v });
      }
    });

    // Charts
    safeChartDestroy(dailyProductivityChart);
    safeChartDestroy(tmpEvolutionChart);
    safeChartDestroy(volumeRankingChart);
    safeChartDestroy(shiftComparisonChart);
    safeChartDestroy(heatmapChart);

    dailyProductivityChart = new Chart(document.getElementById('daily-productivity-chart').getContext('2d'), {
      type: 'bar',
      data: { labels: dayLabels, datasets: [{ label: 'Finalizados', data: dayCounts }] },
      options: baseChartOptions()
    });

    tmpEvolutionChart = new Chart(document.getElementById('tmp-evolution-chart').getContext('2d'), {
      type: 'line',
      data: { labels: dayLabels, datasets: [{ label: 'TMP (h)', data: dayTmpH, tension: 0.3 }] },
      options: baseChartOptions({ yTitle: 'Horas' })
    });

    volumeRankingChart = new Chart(document.getElementById('volume-ranking-chart').getContext('2d'), {
      type: 'bar',
      data: { labels: topTLabels, datasets: [{ label: 'Finalizados', data: topTValues }] },
      options: baseChartOptions({ indexAxis: 'y' })
    });

    shiftComparisonChart = new Chart(document.getElementById('shift-comparison-chart').getContext('2d'), {
      type: 'bar',
      data: { labels: Object.keys(shiftAgg), datasets: [{ label: 'Finalizados', data: Object.values(shiftAgg) }] },
      options: baseChartOptions()
    });

    // Matrix chart (heatmap)
    heatmapChart = new Chart(document.getElementById('heatmap-chart').getContext('2d'), {
      type: 'matrix',
      data: {
        datasets: [{
          label: 'Finalizados',
          data: matrixData,
          backgroundColor(ctx) {
            const v = ctx.raw.v || 0;
            const alpha = vmax ? (0.10 + 0.85 * (v / vmax)) : 0.10;
            return `rgba(59,130,246,${alpha})`;
          },
          width(ctx) {
            const a = ctx.chart.chartArea;
            return (a.right - a.left) / 24 - 1;
          },
          height(ctx) {
            const a = ctx.chart.chartArea;
            return (a.bottom - a.top) / heatDays.length - 1;
          }
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { labels: { color: '#d1d5db' } },
          tooltip: {
            callbacks: {
              title: (items) => {
                const it = items[0];
                const day = heatDays[it.raw.y].slice(5);
                const hour = String(it.raw.x).padStart(2,'0') + ':00';
                return `${day} ${hour}`;
              },
              label: (it) => `Finalizados: ${it.raw.v}`
            }
          }
        },
        scales: {
          x: {
            type: 'linear',
            min: 0,
            max: 23,
            ticks: { color: '#d1d5db', stepSize: 1, callback: (v) => String(v).padStart(2,'0') },
            grid: { display: false }
          },
          y: {
            type: 'linear',
            min: 0,
            max: heatDays.length - 1,
            ticks: { color: '#d1d5db', stepSize: 1, callback: (v) => heatLabelsY[v] ?? '' },
            grid: { display: false }
          }
        }
      }
    });
  }

  function safeChartDestroy(chart) {
    if (chart && typeof chart.destroy === 'function') chart.destroy();
  }

  function baseChartOptions(extra = {}) {
    return {
      responsive: true,
      maintainAspectRatio: false,
      indexAxis: extra.indexAxis || 'x',
      plugins: {
        legend: { labels: { color: '#d1d5db' } }
      },
      scales: {
        x: { ticks: { color: '#d1d5db' }, grid: { display: false } },
        y: { beginAtZero: true, ticks: { color: '#d1d5db' }, grid: { color: 'rgba(255,255,255,0.1)' } }
      }
    };
  }

  // --- Filtros / Combos ---
  const updateStatusFilterOptions = (tab) => {
    const filterStatusSelect = document.getElementById('filter-status');
    let optionsHTML = '';
    if (tab === 'historico') {
      optionsHTML = `<option value="todos">Todos Status</option><option value="Finalizado">Finalizado</option><option value="Cancelado">Cancelado</option>`;
    } else {
      optionsHTML = `
        <option value="todos">Todos Status</option>
        <option value="Prioridade">Prioridade</option>
        <option value="Atrasado">Atrasado</option>
        <option value="Atenção">Atenção</option>
        <option value="Grade queimada">Grade queimada</option>
        <option value="Normal">Normal</option>`;
    }
    filterStatusSelect.innerHTML = optionsHTML;
  };

  const updateTransportadoraFilter = () => {
    const select = document.getElementById('filter-transportadora');
    const dashboardSelect = document.getElementById('dashboard-transportadora-filter');

    const allOps = [...patioData, ...historicoData];
    const transportadoras = [...new Set(allOps.map(op => op.transportadora).filter(Boolean))];

    const currentSelectedValue = select.value;
    const currentDashboardSelectedValue = dashboardSelect.value;

    [select, dashboardSelect].forEach(s => { while (s.options.length > 1) s.remove(1); });

    transportadoras.sort().forEach(t => {
      const option = document.createElement('option');
      option.value = t;
      option.textContent = t;
      select.appendChild(option.cloneNode(true));
      dashboardSelect.appendChild(option);
    });

    select.value = currentSelectedValue;
    dashboardSelect.value = currentDashboardSelectedValue;
  };

  // --- Eventos de tabela ---
  function handleTableClick(e) {
    const button = e.target.closest('button');
    if (!button) return;
    const action = button.dataset.action;
    if (!action) return;

    const id = button.dataset.id;
    if (!id) return;

    selectedOperacao = patioData.find(op => op.id === id) || historicoData.find(op => op.id === id) || ocorrenciasData.find(op => op.id === id);

    if (!selectedOperacao) {
      const occ = ocorrenciasData.find(o => o.id === id);
      if (occ) selectedOperacao = patioData.find(p => p.id === occ.operacaoId) || historicoData.find(h => h.id === occ.operacaoId) || occ;
    }
    if (!selectedOperacao) return;

    switch (action) {
      case 'details': showDetailsModal(); break;
      case 'occurrence': showOccurrenceModal(); break;
      case 'finish': showConfirmModal('Tem certeza que deseja finalizar esta operação?', finalizarOperacao); break;
      case 'cancel': showConfirmModal(`Tem certeza que deseja cancelar a DT ${selectedOperacao.dt}? Esta ação não pode ser desfeita.`, cancelarOperacao); break;
      case 'edit-occurrence': showResolutionModal(); break;
    }
  }

  function showConfirmModal(text, callback) {
    document.getElementById('confirm-modal-text').textContent = text;
    confirmCallback = callback;
    document.getElementById('confirm-modal').classList.remove('hidden');
  }

  // --- Modais (DETALHES / OCORRÊNCIA / RESOLUÇÃO) ---
  window.showDetailsModal = () => {
    if (!selectedOperacao) return;

    document.getElementById('details-modal-title').textContent = `Detalhes da DT: ${selectedOperacao.dt}`;

    const modalContent = document.getElementById('details-modal-content');
    const logSection = document.getElementById('log-section');
    const modalActions = document.getElementById('details-modal-actions');

    const telefoneDigits = getTelefoneFromOperacao(selectedOperacao);
    const telefoneView = telefoneDigits || selectedOperacao.telefone || 'N/A';

    modalContent.innerHTML = `
      <p><strong>Motorista:</strong> ${selectedOperacao.motorista || 'N/A'}</p>
      <p><strong>CPF:</strong> ${selectedOperacao.cpf || 'N/A'}</p>
      <p><strong>Telefone:</strong> ${telefoneView}</p>
      <p><strong>Placa:</strong> ${selectedOperacao.placa || 'N/A'}</p>
      <p><strong>Transportadora:</strong> ${selectedOperacao.transportadora || 'N/A'}</p>
      <p><strong>Destino:</strong> ${selectedOperacao.destino || 'N/A'}</p>
      <p><strong>Agenda:</strong> ${selectedOperacao.agenda || 'N/A'}</p>
      <p><strong>Chegada no Pátio:</strong> ${selectedOperacao.registrationTime ? new Date(selectedOperacao.registrationTime).toLocaleString('pt-BR') : 'N/A'}</p>
    `;

    logSection.innerHTML = `
      <h4 class="text-lg font-bold text-white mt-4">Log de Atividades</h4>
      <div id="log-entries" class="mt-2 space-y-2 max-h-40 overflow-y-auto bg-gray-900 p-2 rounded-md"></div>
      <form id="comment-form" class="mt-4 flex gap-2">
        <input type="text" id="comment-input" class="w-full bg-gray-700 border border-gray-600 rounded-lg py-2 px-3 text-white placeholder-gray-400" placeholder="Adicionar comentário...">
        <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">Salvar</button>
      </form>
    `;
    document.getElementById('comment-form').addEventListener('submit', handleAddComment);
    renderLog(selectedOperacao.id);

    modalActions.innerHTML = '';
    if (telefoneDigits) {
      const message = `Olá ${selectedOperacao.motorista}, por favor, dirija-se à doca para o carregamento da DT ${selectedOperacao.dt}.`;
      const encodedMessage = encodeURIComponent(message);
      const whatsappUrl = `https://wa.me/55${telefoneDigits}?text=${encodedMessage}`;
      modalActions.innerHTML = `
        <a href="${whatsappUrl}" target="_blank" rel="noopener noreferrer"
          class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg flex items-center gap-2">
          Msg WhatsApp
        </a>`;
    }

    document.getElementById('details-modal').classList.remove('hidden');
  };

  window.closeDetailsModal = () => document.getElementById('details-modal').classList.add('hidden');

  window.showOccurrenceModal = () => {
    if (!selectedOperacao) return;
    document.getElementById('occurrence-modal-title').textContent = `Registrar Ocorrência para DT: ${selectedOperacao.dt}`;
    document.getElementById('occurrence-modal').classList.remove('hidden');
  };
  window.closeOccurrenceModal = () => document.getElementById('occurrence-modal').classList.add('hidden');

  window.showResolutionModal = () => {
    if (!selectedOperacao) return;
    document.getElementById('resolution-modal-title').textContent = `Resolver Ocorrência: ${selectedOperacao.dt}`;

    document.getElementById('resolution-modal-content').innerHTML = `
      <p><strong>Problema:</strong> ${selectedOperacao.type}</p>
      <p><strong>Descrição:</strong> ${selectedOperacao.description}</p>
      <p><strong>Resolução Anterior:</strong> ${selectedOperacao.resolucao || 'Nenhuma'}</p>
    `;

    document.getElementById('resolutionText').value = selectedOperacao.resolucao || '';
    document.getElementById('resolutionStatus').value = selectedOperacao.statusOcorrencia || 'Em andamento';

    document.getElementById('resolution-modal').classList.remove('hidden');
  };
  window.closeResolutionModal = () => document.getElementById('resolution-modal').classList.add('hidden');

  // --- Firestore: log de atividades ---
  async function addLogEntry(operacaoId, text, isComment = false) {
    if (!db || !operacaoId) return;
    const logCollectionRef = collection(db, ...DB_BASE, 'logs', operacaoId, 'entries');
    await addDoc(logCollectionRef, { text, timestamp: serverTimestamp(), isComment });
  }

  function renderLog(operacaoId) {
    const logEntriesContainer = document.getElementById('log-entries');
    if (!logEntriesContainer) return;

    const logCollectionRef = collection(db, ...DB_BASE, 'logs', operacaoId, 'entries');

    onSnapshot(logCollectionRef, (querySnapshot) => {
      const entries = [];
      querySnapshot.forEach((d) => entries.push(d.data()));
      entries.sort((a,b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));

      logEntriesContainer.innerHTML = entries.map(entry => {
        const time = entry.timestamp ? new Date(entry.timestamp.seconds * 1000).toLocaleString('pt-BR') : 'agora';
        const commentClass = entry.isComment ? 'bg-blue-900/50 p-3 rounded-lg' : 'text-gray-400';
        return `<div class="text-sm ${commentClass}">
          <p>${entry.text}</p><p class="text-xs text-gray-500 mt-1">${time}</p>
        </div>`;
      }).join('');
    });
  }

  async function handleAddComment(e) {
    e.preventDefault();
    if (!db || !selectedOperacao) return;
    const input = document.getElementById('comment-input');
    const commentText = input.value.trim();
    if (commentText) {
      await addLogEntry(selectedOperacao.id, commentText, true);
      input.value = '';
    }
  }

  // --- Clear histórico / ocorrências ---
  async function clearHistory() {
    if (!db) return;
    const collectionRef = colRef('historico');
    const querySnapshot = await getDocs(collectionRef);
    const batch = writeBatch(db);
    querySnapshot.forEach(d => batch.delete(d.ref));
    try { await batch.commit(); console.log("Histórico limpo com sucesso."); }
    catch (error) { console.error("Erro ao limpar o histórico: ", error); }
  }

  async function clearOccurrences() {
    if (!db) return;
    const collectionRef = colRef('ocorrencias');
    const querySnapshot = await getDocs(collectionRef);
    const batch = writeBatch(db);
    querySnapshot.forEach(d => batch.delete(d.ref));
    try { await batch.commit(); console.log("Ocorrências limpas com sucesso."); }
    catch (error) { console.error("Erro ao limpar as ocorrências: ", error); }
  }

  // --- Export CSV ---
  const exportToCsv = () => {
    const searchTerm = document.getElementById('search-input').value.toLowerCase();
    const statusFilter = document.getElementById('filter-status').value;
    const transportadoraFilter = document.getElementById('filter-transportadora').value;
    const dateFilterValue = document.getElementById('filter-date').value;
    const shiftFilterValue = document.getElementById('filter-shift').value;

    let dataToExport, headers;

    if (activeTab === 'ocorrencias') {
      dataToExport = ocorrenciasData.filter(op =>
        (op.dt?.toLowerCase() || '').includes(searchTerm) ||
        (op.description?.toLowerCase() || '').includes(searchTerm)
      );
      headers = ['Data','DT','Canal','Prioridade','Problema Identificado','Descrição','Status da Ocorrência','Resolução','Resolvido Em'];
    } else if (activeTab === 'historico') {
      let filteredHistorico = historicoData;

      if (dateFilterValue) {
        const filterDate = new Date(dateFilterValue);
        filterDate.setDate(filterDate.getDate() + 1);
        const filterDateString = filterDate.toDateString();
        filteredHistorico = filteredHistorico.filter(op => op.finishedTime && new Date(op.finishedTime).toDateString() === filterDateString);
      }
      if (shiftFilterValue !== 'todos' && dateFilterValue) {
        const shift = parseInt(shiftFilterValue, 10);
        const shiftTimes = { 1:{start:6,end:14}, 2:{start:14,end:22}, 3:{start:22,end:6} };
        const { start, end } = shiftTimes[shift];
        filteredHistorico = filteredHistorico.filter(op => {
          if (!op.finishedTime) return false;
          const opHour = new Date(op.finishedTime).getHours();
          return start < end ? (opHour >= start && opHour < end) : (opHour >= start || opHour < end);
        });
      }

      dataToExport = filteredHistorico.filter(op => {
        const byText = (op.dt?.toLowerCase() || '').includes(searchTerm) || (op.motorista?.toLowerCase() || '').includes(searchTerm);
        const byTransp = transportadoraFilter === 'todas' || op.transportadora === transportadoraFilter;
        return byText && byTransp;
      });

      headers = ['DT','Status Final','Agenda','Motorista','Transportadora','Finalizado Em','Tempo Total no Pátio'];
    } else {
      dataToExport = patioData.filter(op => {
        const { statusText } = getPriorityStatusLogic(op);
        const statusMatch = statusFilter === 'todos' || statusText.toLowerCase().includes(statusFilter.toLowerCase());
        const textMatch = (op.dt?.toLowerCase() || '').includes(searchTerm) || (op.motorista?.toLowerCase() || '').includes(searchTerm);
        const transpMatch = transportadoraFilter === 'todas' || op.transportadora === transportadoraFilter;
        return textMatch && transpMatch && statusMatch;
      });
      headers = ['DT','Status','Agenda','Tempo no Pátio','Motorista','Transportadora'];
    }

    const rows = dataToExport.map(op => {
      if (activeTab === 'ocorrencias') {
        return [
          `"${op.timestamp ? new Date(op.timestamp.seconds * 1000).toLocaleString('pt-BR') : 'N/A'}"`,
          `"${op.dt}"`,
          `"${op.canal}"`,
          `"${op.prioridade}"`,
          `"${op.type}"`,
          `"${op.description}"`,
          `"${op.statusOcorrencia}"`,
          `"${op.resolucao || ''}"`,
          `"${op.resolvidoEm ? new Date(op.resolvidoEm.seconds * 1000).toLocaleString('pt-BR') : ''}"`
        ].join(',');
      }

      const { statusText } = getPriorityStatusLogic(op);

      if (activeTab === 'historico') {
        const tempoTotal = (op.finishedTime && op.registrationTime) ? formatMilliseconds(op.finishedTime - op.registrationTime) : 'N/A';
        return [
          `"${op.dt || ''}"`,
          `"${op.status}"`,
          `"${op.agenda || ''}"`,
          `"${op.motorista || ''}"`,
          `"${op.transportadora || ''}"`,
          `"${op.finishedTime ? new Date(op.finishedTime).toLocaleString('pt-BR') : 'N/A'}"`,
          `"${tempoTotal}"`
        ].join(',');
      }

      const tempoPatio = op.registrationTime ? getElapsedTime(op.registrationTime) : 'N/A';
      return [
        `"${op.dt || ''}"`,
        `"${statusText}"`,
        `"${op.agenda || ''}"`,
        `"${tempoPatio}"`,
        `"${op.motorista || ''}"`,
        `"${op.transportadora || ''}"`
      ].join(',');
    });

    const csvContent = "data:text/csv;charset=utf-8," + headers.join(",") + "\n" + rows.join("\n");
    const encodedUri = encodeURI(csvContent);
    const link = document.createElement("a");
    link.setAttribute("href", encodedUri);
    link.setAttribute("download", `heilog_export_${activeTab}_${new Date().toISOString().split('T')[0]}.csv`);
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  };

  // --- Inicialização / Auth / Snapshots ---
  window.addEventListener('load', () => {
    audioContext = new (window.AudioContext || window.webkitAudioContext)();
    const app = initializeApp(firebaseConfig);
    db = getFirestore(app);
    const auth = getAuth(app);
    setLogLevel('error');

    document.getElementById('filter-date').valueAsDate = new Date();
    Notification.requestPermission();

    const soundBtn = document.getElementById('toggle-sound-btn');
    const savedSoundPref = localStorage.getItem('heilogSoundEnabled');
    if (savedSoundPref !== null) soundEnabled = JSON.parse(savedSoundPref);
    soundBtn.innerHTML = soundEnabled ? ICONS.SOUND_ON : ICONS.SOUND_OFF;
    soundBtn.addEventListener('click', () => {
      soundEnabled = !soundEnabled;
      soundBtn.innerHTML = soundEnabled ? ICONS.SOUND_ON : ICONS.SOUND_OFF;
      localStorage.setItem('heilogSoundEnabled', JSON.stringify(soundEnabled));
    });

    // Monta HTML base dos modais
    document.getElementById('details-modal').innerHTML =
      `<div class="bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-2xl relative">
        <h3 id="details-modal-title" class="text-xl font-bold text-white mb-4"></h3>
        <button onclick="window.closeDetailsModal()" class="absolute top-4 right-4 text-gray-500 hover:text-white">
          <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
            stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="18" x2="6" y1="6" y2="18"/><line x1="6" x2="18" y1="6" y2="18"/>
          </svg>
        </button>
        <div id="details-modal-content" class="text-gray-300 space-y-2 max-h-[60vh] overflow-y-auto"></div>
        <div id="log-section" class="mt-6 pt-4 border-t border-gray-700"></div>
        <div id="details-modal-actions" class="mt-4 pt-4 border-t border-gray-700 flex items-center gap-4"></div>
      </div>`;

    document.getElementById('occurrence-modal').innerHTML =
      `<div class="bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-lg relative">
        <h3 id="occurrence-modal-title" class="text-xl font-bold text-white mb-4"></h3>
        <button onclick="window.closeOccurrenceModal()" class="absolute top-4 right-4 text-gray-500 hover:text-white">
          <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
            stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="18" x2="6" y1="6" y2="18"/><line x1="6" x2="18" y1="6" y2="18"/>
          </svg>
        </button>
        <form id="occurrence-form" class="space-y-4">
          <div>
            <label for="occurrenceType" class="block text-sm font-medium text-gray-300">Problema Identificado</label>
            <select id="occurrenceType" name="type"
              class="mt-1 block w-full bg-gray-700 border border-gray-600 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 sm:text-sm">
              <option>Mecânico</option><option>Operacional</option><option>Trânsito</option><option>Climático</option><option>Fiscal</option><option>Outro</option>
            </select>
          </div>
          <div>
            <label for="occurrenceDescription" class="block text-sm font-medium text-gray-300">Descrição</label>
            <textarea id="occurrenceDescription" name="description" rows="3" required
              class="mt-1 block w-full bg-gray-700 border border-gray-600 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 sm:text-sm"></textarea>
          </div>
          <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">Salvar Ocorrência</button>
        </form>
      </div>`;

    document.getElementById('resolution-modal').innerHTML =
      `<div class="bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-lg relative">
        <h3 id="resolution-modal-title" class="text-xl font-bold text-white mb-4"></h3>
        <button onclick="window.closeResolutionModal()" class="absolute top-4 right-4 text-gray-500 hover:text-white">
          <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
            stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="18" x2="6" y1="6" y2="18"/><line x1="6" x2="18" y1="6" y2="18"/>
          </svg>
        </button>
        <div id="resolution-modal-content" class="text-gray-300 space-y-2 mb-4"></div>
        <form id="resolution-form" class="space-y-4">
          <hr class="border-gray-600">
          <div>
            <label for="resolutionText" class="block text-sm font-medium text-gray-300 mt-4">Ação de Resolução</label>
            <textarea id="resolutionText" name="resolution" rows="4"
              class="mt-1 block w-full bg-gray-700 border border-gray-600 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 sm:text-sm"></textarea>
          </div>
          <div>
            <label for="resolutionStatus" class="block text-sm font-medium text-gray-300">Atualizar Status</label>
            <select id="resolutionStatus" name="status"
              class="mt-1 block w-full bg-gray-700 border border-gray-600 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 sm:text-sm">
              <option value="Em andamento">Em andamento</option>
              <option value="Concluído">Concluído</option>
              <option value="Cancelado">Cancelado</option>
            </select>
          </div>
          <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">Salvar Resolução</button>
        </form>
      </div>`;

    updateStatusFilterOptions('patio');

    document.getElementById('search-input').addEventListener('input', debouncedRender);
    document.getElementById('filter-status').addEventListener('change', debouncedRender);
    document.getElementById('filter-transportadora').addEventListener('change', debouncedRender);
    document.getElementById('filter-date').addEventListener('change', debouncedRender);
    document.getElementById('filter-shift').addEventListener('change', debouncedRender);

    document.getElementById('clear-date-filter-btn').addEventListener('click', () => {
      document.getElementById('filter-date').valueAsDate = new Date();
      document.getElementById('filter-shift').value = 'todos';
      debouncedRender();
    });

    document.getElementById('dashboard-transportadora-filter').addEventListener('change', renderManagerDashboard);
    document.getElementById('export-csv-btn').addEventListener('click', exportToCsv);

    document.getElementById('clear-history-btn').addEventListener('click', () => {
      showConfirmModal('Tem certeza que deseja limpar todo o histórico? Esta ação é irreversível e removerá todos os registros permanentemente.', clearHistory);
    });
    document.getElementById('clear-occurrences-btn').addEventListener('click', () => {
      showConfirmModal('Tem certeza que deseja limpar todas as ocorrências? Esta ação é irreversível.', clearOccurrences);
    });

    document.getElementById('occurrence-form').addEventListener('submit', handleAddOccurrence);
    document.getElementById('resolution-form').addEventListener('submit', handleUpdateResolution);
    document.getElementById('table-body').addEventListener('click', handleTableClick);

    document.getElementById('confirm-modal-cancel').addEventListener('click', () => {
      document.getElementById('confirm-modal').classList.add('hidden');
      confirmCallback = null;
    });
    document.getElementById('confirm-modal-confirm').addEventListener('click', () => {
      if (confirmCallback) confirmCallback();
      document.getElementById('confirm-modal').classList.add('hidden');
      confirmCallback = null;
    });

    const allTabs = [
      document.getElementById('tab-patio'),
      document.getElementById('tab-historico'),
      document.getElementById('tab-ocorrencias'),
      document.getElementById('tab-performance'),
      document.getElementById('tab-dashboard')
    ];

    allTabs.forEach(tab => tab.addEventListener('click', () => {
      allTabs.forEach(t => {
        t.classList.remove('text-white', 'border-blue-500');
        t.classList.add('text-gray-400', 'border-transparent');
      });
      tab.classList.add('text-white', 'border-blue-500');
      tab.classList.remove('text-gray-400', 'border-transparent');

      activeTab = tab.id.replace('tab-', '');

      const showPerformance = activeTab === 'performance';
      const showDashboard = activeTab === 'dashboard';
      const showMainTable = !showPerformance && !showDashboard;

      document.getElementById('kpi-section').style.display = showMainTable ? 'grid' : 'none';
      document.getElementById('table-main-content').style.display = showMainTable ? 'block' : 'none';
      document.getElementById('performance-content').style.display = showPerformance ? 'block' : 'none';
      document.getElementById('dashboard-content').style.display = showDashboard ? 'block' : 'none';

      const showHistorico = activeTab === 'historico';
      const showOcorrencias = activeTab === 'ocorrencias';

      document.getElementById('clear-history-btn').style.display = showHistorico ? 'flex' : 'none';
      document.getElementById('clear-occurrences-btn').style.display = showOcorrencias ? 'flex' : 'none';
      document.getElementById('advanced-filters').style.display = showHistorico ? 'flex' : 'none';
      document.getElementById('filter-status').style.display = showHistorico ? 'none' : 'block';

      updateStatusFilterOptions(activeTab);
      document.getElementById('table-title').textContent = tab.textContent;

      debouncedRender();
    }));

    // Auth
    const statusEl = document.getElementById('firebase-status');
    statusEl.textContent = 'Conectando ao Firebase…';

    (async () => {
      try {
        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
          await signInWithCustomToken(auth, __initial_auth_token);
        } else {
          await signInAnonymously(auth);
        }
      } catch (error) {
        console.warn("Falha no login (tentando anônimo como fallback):", error?.message || error);
        try {
          await signInAnonymously(auth);
        } catch (anonError) {
          console.error("Crítico: Falha também no login anônimo:", anonError);
        }
      }
      finally {
        // listeners serão anexados após autenticar (onAuthStateChanged)
      }
})();

    let listenersAttached = false;

    onAuthStateChanged(auth, user => {
      if (!user) {
        statusEl.textContent = `Firebase: aguardando login… (Base: /${DB_BASE.join('/')})`;
        return;
      }
      statusEl.textContent = `Firebase OK — UID: ${user.uid} — Base: /${DB_BASE.join('/')}`;
      if (!listenersAttached) {
        listenersAttached = true;
        initFirestoreListeners();
      }
    });

    // Timer do pátio
    if (timerIntervalId) clearInterval(timerIntervalId);
    timerIntervalId = setInterval(() => {
      if (activeTab === 'patio') {
        document.querySelectorAll('.timer-cell').forEach(cell => {
          const time = cell.getAttribute('data-registration-time');
          if (time) cell.textContent = getElapsedTime(parseInt(time));
        });
      }
    }, 1000);

    // Atualizações periódicas
    setInterval(() => {
      if (activeTab === 'performance') renderPerformanceDashboard();
      if (activeTab === 'dashboard') renderManagerDashboard();
      if (activeTab === 'patio') { checkSystemAlerts(); runPredictiveAnalysis(); }
    }, 60000);
  });

  function initFirestoreListeners() {
    // --- CADASTRO DE MOTORISTAS (CPF -> telefone) ---
    const attachDriverSnapshot = (collectionName) => {
      const ref = colRef(collectionName);
      onSnapshot(ref, snap => {
        snap.docs.forEach(d => {
          const data = d.data();
          const cpfRaw = data.cpf || d.id;
          const phoneRaw = data.phone || data.telefone;
          if (!cpfRaw || !phoneRaw) return;
          const cpfKey = String(cpfRaw).replace(/\D/g, '');
          driverPhoneByCpf[cpfKey] = String(phoneRaw);
        });
      }, err => console.error(`[Firestore] erro drivers/${collectionName}`, err));
    };
    attachDriverSnapshot('drivers');
    attachDriverSnapshot('motoristas');

    // --- PÁTIO ---
    onSnapshot(colRef('patio'), snap => {
      const newPatioData = snap.docs.map(d => ({ ...d.data(), id: d.id }));
      newlyAdded.clear();

      newPatioData.forEach(op => {
        const { statusText, isAlert } = getPriorityStatusLogic(op);
        const isExisting = patioData.some(oldOp => oldOp.id === op.id);
        if (isAlert && !notifiedVehicles.has(op.id)) {
          playAlertSound();
          showBrowserNotification(`Alerta de Prioridade: ${op.dt}`, `Veículo entrou em status de ${statusText}`, `alert-${op.id}`);
          notifiedVehicles.add(op.id);
        }
        if (!isExisting) {
          newlyAdded.add(op.id);
          setTimeout(() => { newlyAdded.delete(op.id); debouncedRender(); }, 5000);
        }
      });

      patioData = newPatioData;
      checkSystemAlerts();
      runPredictiveAnalysis();
      debouncedRender();
    }, err => {
      console.error("[Firestore] erro patio:", err);
      document.getElementById('firebase-status').textContent = `ERRO Firestore (patio): ${err?.code || err?.message || err}`;
    });

    // --- HISTÓRICO ---
    onSnapshot(colRef('historico'), snap => {
      historicoData = snap.docs.map(d => ({ ...d.data(), id: d.id }));
      debouncedRender();
    }, err => console.error("[Firestore] erro historico:", err));

    // --- OCORRÊNCIAS ---
    onSnapshot(colRef('ocorrencias'), snap => {
      ocorrenciasData = snap.docs.map(d => ({ ...d.data(), id: d.id }))
        .sort((a,b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));
      debouncedRender();
    }, err => console.error("[Firestore] erro ocorrencias:", err));
  }

  // --- Ações ---
  async function finalizarOperacao() {
    if (!db || !selectedOperacao) return;
    try {
      const finalizada = { ...selectedOperacao, status: 'Finalizado', finishedTime: Date.now() };
      const batch = writeBatch(db);

      batch.set(docRef('historico', selectedOperacao.id), finalizada);
      batch.delete(docRef('patio', selectedOperacao.id));

      await batch.commit();
      await addLogEntry(selectedOperacao.id, 'Operação finalizada com sucesso via Painel.');
    } catch (error) {
      console.error("Falha ao finalizar operação:", error);
    }
  }

  async function cancelarOperacao() {
    if (!db || !selectedOperacao) return;
    try {
      const cancelada = { ...selectedOperacao, status: 'Cancelado', finishedTime: Date.now() };
      const batch = writeBatch(db);

      batch.set(docRef('historico', selectedOperacao.id), cancelada);
      batch.delete(docRef('patio', selectedOperacao.id));

      await batch.commit();
      await addLogEntry(selectedOperacao.id, 'Operação cancelada via Painel.');
    } catch (error) {
      console.error("Falha ao cancelar operação:", error);
    }
  }

  async function handleAddOccurrence(e) {
    e.preventDefault();
    if (!db || !selectedOperacao) return;
    const form = document.getElementById('occurrence-form');
    const formData = new FormData(form);
    const description = formData.get('description');

    await addDoc(colRef('ocorrencias'), {
      type: formData.get('type'),
      description,
      dt: selectedOperacao.dt,
      operacaoId: selectedOperacao.id,
      timestamp: serverTimestamp(),
      canal: 'Painel',
      prioridade: getPriorityStatusLogic(selectedOperacao).statusText,
      statusOcorrencia: 'Em andamento',
      resolucao: ''
    });

    await addLogEntry(selectedOperacao.id, `Ocorrência registrada: ${description}`);
    window.closeOccurrenceModal();
    form.reset();
  }

  async function handleUpdateResolution(e) {
    e.preventDefault();
    if (!db || !selectedOperacao) return;
    const form = document.getElementById('resolution-form');
    const formData = new FormData(form);
    const resolution = formData.get('resolution');
    const status = formData.get('status');

    await updateDoc(docRef('ocorrencias', selectedOperacao.id), {
      resolucao: resolution,
      statusOcorrencia: status,
      resolvidoEm: status === 'Concluído' ? serverTimestamp() : null
    });

    // Se selectedOperacao for ocorrência, operacaoId aponta para a DT.
    const opId = selectedOperacao.operacaoId || selectedOperacao.id;
    await addLogEntry(opId, `Resolução da ocorrência: ${resolution} (Status: ${status})`);
    window.closeResolutionModal();
  }

  // --- Preditivo + Alertas ---
  function runPredictiveAnalysis() {
    const ONE_HOUR = 3600 * 1000;
    const now = Date.now();
    const recentArrivals = patioData.filter(op => (now - op.registrationTime) < ONE_HOUR).length;
    const finishedInLastHour = historicoData.filter(op => op.finishedTime && (now - op.finishedTime) < ONE_HOUR);

    if (!finishedInLastHour.length) { document.getElementById('predictive-alert').innerHTML = ``; return; }

    const avgStayTime = finishedInLastHour.reduce((acc, op) => acc + (op.finishedTime - op.registrationTime), 0) / finishedInLastHour.length;
    const vehiclesPerHour = recentArrivals;
    const projectedOccupancy = patioData.length + vehiclesPerHour;
    const capacity = 50;
    const occupancyRate = (projectedOccupancy / capacity);

    const alertDiv = document.getElementById('predictive-alert');
    if (occupancyRate > 0.9) {
      alertDiv.innerHTML = `<div class="p-2 bg-red-800 border border-red-600 rounded-lg text-sm text-center"><strong>Alerta Preditivo:</strong> Risco de gargalo no pátio na próxima hora. Ocupação projetada: ${(occupancyRate * 100).toFixed(0)}%</div>`;
    } else if (occupancyRate > 0.75) {
      alertDiv.innerHTML = `<div class="p-2 bg-yellow-800 border border-yellow-600 rounded-lg text-sm text-center"><strong>Atenção:</strong> Pátio pode atingir alta ocupação na próxima hora. Ocupação projetada: ${(occupancyRate * 100).toFixed(0)}%</div>`;
    } else {
      alertDiv.innerHTML = '';
    }
  }

  function createAlertBanner(message, level) {
    const alertsContainer = document.getElementById('system-alerts-container');
    const alertDiv = document.createElement('div');
    let bgColor = 'bg-yellow-800 border-yellow-600';
    if (level === 'high') bgColor = 'bg-red-800 border-red-600';
    alertDiv.className = `alert-banner p-3 rounded-lg border text-sm ${bgColor}`;
    alertDiv.innerHTML = `<strong>ALERTA DO SISTEMA:</strong> ${message}`;
    alertsContainer.appendChild(alertDiv);
  }

  function checkSystemAlerts() {
    const alertsContainer = document.getElementById('system-alerts-container');
    alertsContainer.innerHTML = '';

    const longDelayedVehicles = patioData.filter(op => {
      const { statusText } = getPriorityStatusLogic(op);
      return statusText === "Atrasado" && (Date.now() - op.registrationTime) > 3600000;
    });
    if (longDelayedVehicles.length > 0) {
      const dts = longDelayedVehicles.map(v => v.dt).join(', ');
      createAlertBanner(`Atenção Sênior: Veículo(s) ${dts} estão atrasados há mais de 1 hora.`, 'high');
    }

    const attentionCount = patioData.filter(op => getPriorityStatusLogic(op).statusText === 'Atenção').length;
    if (attentionCount > 5) {
      createAlertBanner(`Alerta de Volume: ${attentionCount} veículos em status de 'Atenção'. Risco de atrasos.`, 'medium');
    }

    const fiscalOccurrence = ocorrenciasData.find(o => o.type === 'Fiscal' && !notifiedVehicles.has(o.id));
    if (fiscalOccurrence) {
      createAlertBanner(`Ocorrência Fiscal registrada para DT ${fiscalOccurrence.dt}. (simulação de aviso)`, 'high');
      notifiedVehicles.add(fiscalOccurrence.id);
    }
  }
</script>
</body>
</html>
